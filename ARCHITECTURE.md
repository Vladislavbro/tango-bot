# Архитектура кода Танго Бота

Этот документ описывает структуру и основные компоненты Telegram бота для записи на уроки танго.

## Обзор

Бот построен на языке Python с использованием библиотеки `python-telegram-bot`. Он реализует диалоговый сценарий для сбора информации от пользователя (имя, телефон) и записи его на определенный временной слот.

Основная логика построена вокруг `ConversationHandler`, который управляет состоянием диалога с пользователем.

## Структура файлов

```
.
├── .env                  # Файл для хранения секретного токена бота
├── .gitignore            # Определяет файлы, игнорируемые Git
├── main.py               # Основной файл с кодом бота
├── requirements.txt      # Список зависимостей Python
└── README.md             # Описание проекта и инструкция по запуску
└── ARCHITECTURE.md       # Этот файл
```

## Компоненты `main.py`

Файл `main.py` содержит всю логику бота:

1.  **Импорты и настройка:**
    *   Импортируются необходимые классы из `telegram.ext` и другие библиотеки (`logging`, `os`, `dotenv`).
    *   Загружается токен бота из файла `.env` с помощью `python-dotenv`.
    *   Настраивается базовое логирование для отслеживания работы бота.

2.  **Состояния диалога (States):**
    *   Константы (`START_CHOICE`, `GET_NAME`, `GET_PHONE`, `CONFIRM_PHONE`, `CHOOSE_SLOT`, `CONFIRMATION`) определяют различные этапы разговора с пользователем.

3.  **Функции-обработчики (Handlers):**
    *   `start()`: Запускается командой `/start`, приветствует пользователя и предлагает кнопки для начала записи или получения деталей.
    *   `start_choice_callback()`: Обрабатывает нажатия на кнопки в стартовом сообщении.
    *   `get_name()`: Получает имя пользователя, сохраняет его в `context.user_data` и запрашивает телефон.
    *   `get_phone()`: Получает телефон, сохраняет и запрашивает подтверждение.
    *   `confirm_phone_callback()`: Обрабатывает кнопки подтверждения телефона.
    *   `choose_slot_callback()`: Обрабатывает выбор временного слота, сохраняет его и отправляет финальное подтверждение.
    *   `confirmation()`: Обрабатывает текстовые ответы пользователя после подтверждения записи (например, вопросы).
    *   `cancel()`: Запускается командой `/cancel`, прерывает диалог и очищает `context.user_data`.
    *   `fallback()`: Обрабатывает любые сообщения (текст, команды, стикеры и т.д.), которые не распознаны на текущем шаге диалога или вне активного диалога, предлагая пользователю подсказку.

4.  **`ConversationHandler`:**
    *   Это главный организатор диалога.
    *   `entry_points`: Определяет, как начать диалог (в данном случае, команда `/start`).
    *   `states`: Сопоставляет каждое состояние (`GET_NAME`, `GET_PHONE` и т.д.) с соответствующими обработчиками (например, `MessageHandler` для ожидания текста, `CallbackQueryHandler` для ожидания нажатия кнопки).
    *   `fallbacks`: Определяет обработчики, которые вызываются, если ввод пользователя не соответствует ожидаемому на текущем шаге (`cancel`, `fallback`).
    *   `conversation_timeout`: Устанавливает время бездействия пользователя, после которого диалог автоматически завершится.

5.  **Функция `main()`:**
    *   Проверяет наличие токена.
    *   Создает экземпляр `Application`.
    *   Создает и добавляет `ConversationHandler` в приложение.
    *   Добавляет дополнительный `MessageHandler` для обработки неизвестных команд вне диалога.
    *   Запускает бота в режиме опроса (`run_polling`).

## Зависимости

Основные зависимости перечислены в `requirements.txt`:
*   `python-telegram-bot`: Библиотека для взаимодействия с Telegram Bot API.
*   `python-dotenv`: Для загрузки переменных окружения из `.env` файла.

## Конфигурация и безопасность

*   Токен бота хранится в файле `.env`, который не должен попадать в систему контроля версий (добавлен в `.gitignore`).
*   Файл `.gitignore` также исключает другие ненужные файлы и директории (виртуальное окружение, кеш Python, файлы IDE).

## Потенциальные улучшения

*   **Хранение данных:** Реализовать сохранение записей в файл (CSV, JSON) или базу данных (SQLite, PostgreSQL).
*   **Динамические слоты:** Загружать доступные слоты из файла конфигурации или базы данных вместо жесткого кодирования.
*   **Валидация ввода:** Добавить проверку корректности введенного номера телефона.
*   **Уведомления:** Реализовать отправку напоминаний пользователям перед уроком. 